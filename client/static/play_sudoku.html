<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ò–≥—Ä–∞ –≤ —Å—É–¥–æ–∫—É</title>
<style>
    body {
        background-color: #0f0f3b;
        color: aliceblue;
        margin: 20px;
        font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
    }
    table {
        border-collapse: collapse;
        margin: 20px 0;
    }
    td {
        border: 1px solid lightskyblue;
        width: 40px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        height: 40px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
        text-align: center;
        color: aliceblue;
        background-color: #262441;
    }
    input {
        width: 40px;
        height: 40px;
        text-align: center;
        font-size: 24px;
        color: aliceblue;
        background-color: #262441;
        font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
    }
    button {
        padding: 10px 30px;
        margin: 10px 20px 10px 0;
        font-size: 20px;
        border: none;
        border-radius: 15px;
        color: #262441;
        background-color: lightskyblue;
        font-weight: bold;
        font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
    }
    .result {
        text-align: center;
        font-size: 24px;
    }
    .top { border-top: 4px solid lightskyblue; }
    .bottom { border-bottom: 4px solid lightskyblue; }
    .left { border-left: 4px solid lightskyblue; }
    .right { border-right: 4px solid lightskyblue; }
</style>
</head>
<body>
<!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
<button id="logoutBtn">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
<button id="solveBtn">–ü–æ–ª—É—á–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
<h1>–ò–≥—Ä–∞ –≤ —Å—É–¥–æ–∫—É</h1>

<!-- –°–ø–∏—Å–æ–∫ —Å—É–¥–æ–∫—É -->
<h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—É–¥–æ–∫—É</h2>
<div id="sudokuList"></div>

<!-- –¢–µ–∫—É—â–∏–π —Å—É–¥–æ–∫—É -->
<h2>–¢–µ–∫—É—â–∏–π —Å—É–¥–æ–∫—É</h2>
<div id="currentSudoku"></div>

<!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
<button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>

<div class="result" id="resultMsg"></div>

<script>

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
const token = localStorage.getItem('token');
if (!token) {
  // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  window.location.href = '/login.html';
}

let sudokus = [];
let currentSudoku = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—É–¥–æ–∫—É
async function loadSudokus() {
    const response = await fetch(`/api/sudoku`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token,
            }
        });

    if (response.ok) {
        const data = await response.json();
        console.log(data);
        let sudokus = [];
        for(let i = 0; i < data.ids.length; i++) {
            sudokus.push({
                id: data.ids[i],
                board: data.boards[i],
                difficulty: data.difficulties[i],
                isSolved: data.is_solved[i]
            });
        }

        renderSudokuList(sudokus);
    } else {
        alert('–í–æ –≤—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞. –°—Ç–∞—Ç—É—Å –æ—à–∏–±–∫–∏: ' + response.status);
    }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Å—É–¥–æ–∫—É
function renderSudokuList(sudokus) {
    const container = document.getElementById('sudokuList');
    container.innerHTML = '';

    sudokus.forEach((sudoku) => {
        const btn = document.createElement('button');
        const statusEmoji = sudoku.isSolved ? "üü¢" : "üî¥";
        btn.textContent = `–°—É–¥–æ–∫—É ${sudoku.id}, –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${sudoku.difficulty} ${statusEmoji}`;
        btn.onclick = () => loadSudoku(sudoku.id, sudoku.board);
        container.appendChild(btn);
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—É–¥–æ–∫—É
async function loadSudoku(sudoku_id, board) {
    renderSudoku(sudoku_id, board);
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—É–¥–æ–∫—É
function renderSudoku(sudoku_id, puzzleString) {
    const container = document.getElementById('currentSudoku');
    container.innerHTML = '';

    const table = document.createElement('table');
    const tbody = document.createElement('tbody');
    currentSudoku = sudoku_id;

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Ö–æ–¥—è—â—É—é —Å—Ç—Ä–æ–∫—É –≤ –º–∞—Å—Å–∏–≤ –∏–∑ 81 —ç–ª–µ–º–µ–Ω—Ç–∞
    const puzzleArray = [...puzzleString].map(char => char !== '0' ? parseInt(char) : '');

    for (let i = 0; i < 9; i++) {
        const tr = document.createElement('tr');

        for (let j = 0; j < 9; j++) {
            const index = i * 9 + j;

            let classes = '';
            if (i % 3 === 0 && i != 0) classes += ' top'; // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –±–ª–æ–∫–∞
            if (i === 8) classes += ' bottom'; // –ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
            if (j % 3 === 0 && j != 0) classes += ' left'; // –õ–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –±–ª–æ–∫–∞
            if (j === 8) classes += ' right'; // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞

            const td = document.createElement('td');
            td.className = classes.trim();

            const inputEl = document.createElement('input');
            inputEl.type = 'number';
            inputEl.min = '0';
            inputEl.max = '9';
            inputEl.value = puzzleArray[index]; // –ó–Ω–∞—á–µ–Ω–∏–µ —è—á–µ–π–∫–∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞
            inputEl.oninput = function () {
                this.value = this.value.slice(0, 1); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤–≤–æ–¥ –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä–æ–π
            };
            td.appendChild(inputEl);
            tr.appendChild(td);
        }

        tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    container.appendChild(table);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è
async function checkSolution() {
    // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    const inputs = document.querySelectorAll('#currentSudoku input');

    const solution = Array.from(inputs).map(input => parseInt(input.value) || 0);
    const solutionStr = solution.map(num => num.toString()).join('');

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
    const response = await fetch(`/api/check_sudoku`, {
      method:'POST',
      headers: {
                'Content-Type': 'application/json',
                'Authorization': token,
            },
      body: JSON.stringify({ Solution: solutionStr, SudokuId: currentSudoku })
    });

    const resultData = await response.json();

    if (resultData.isCorrect && currentSudoku !== null) {
        const buttons = document.querySelectorAll('#sudokuList button');
        buttons.forEach(button => {
            if (button.textContent.includes(`–°—É–¥–æ–∫—É ${currentSudoku},`)) {
                button.textContent = button.textContent.replace('üî¥', 'üü¢');
            }
        });
    }
    document.getElementById('resultMsg').textContent= resultData.isCorrect ? '–†–µ—à–µ–Ω–∏–µ –≤–µ—Ä–Ω–æ–µ!' : '–†–µ—à–µ–Ω–∏–µ –Ω–µ–≤–µ—Ä–Ω–æ–µ!';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('token');
  alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
  window.location.href = '/login.html';
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ä–µ—à–∞—Ç–µ–ª—é —Å—É–¥–æ–∫—É
document.getElementById('solveBtn').addEventListener('click', () => {
  window.location.href = '/sudoku.html';
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.getElementById('checkBtn').onclick=checkSolution;

loadSudokus();

</script>
</body>
</html>